name: Run Database Migrations

on:
  push:
    branches:
      - develop
    paths:
      - "tools/migrations/sql/**"
      - ".github/workflows/migrations-deploy.yml"
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  FLYWAY_AUTH_TASK_FAMILY: ${{ secrets.FLYWAY_AUTH_TASK_FAMILY }}
  PRIVATE_SUBNET_1: ${{ secrets.PRIVATE_SUBNET_1 }}
  PRIVATE_SUBNET_2: ${{ secrets.PRIVATE_SUBNET_2 }}
  ECS_SECURITY_GROUP: ${{ secrets.ECS_SECURITY_GROUP }}

jobs:
  run-migrations:
    name: Run Migrations
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Run Flyway migration for auth database
        run: |
          set -e
          
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition ${{ env.FLYWAY_AUTH_TASK_FAMILY }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ env.PRIVATE_SUBNET_1 }},${{ env.PRIVATE_SUBNET_2 }}],securityGroups=[${{ env.ECS_SECURITY_GROUP }}],assignPublicIp=DISABLED}" \
            --query 'tasks[0].taskArn' \
            --output text)
          
          echo "Started Flyway task: $TASK_ARN"
          
          aws ecs wait tasks-stopped --cluster ${{ env.ECS_CLUSTER }} --tasks $TASK_ARN
          
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --tasks $TASK_ARN \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)
          
          [ "$EXIT_CODE" = "0" ] || exit 1
          
          echo "Migration completed successfully"
